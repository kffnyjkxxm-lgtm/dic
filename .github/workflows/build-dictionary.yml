name: Build Dictionary PDF

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest-8-core

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4  # 拉取 dictionary.md 和 template.typ

    - name: Install Dependencies
      run: |
        # 更新 apt 并安装 wget、tar 等基本工具（Ubuntu 已预装大部分）
        sudo apt update
        sudo apt install -y wget tar xz-utils  # xz-utils 用于解压 .tar.xz

    - name: Install Latest Pandoc (Direct Download)
      run: |
        # 下载最新稳定版 Pandoc（3.1.13+，支持 Typst 无 Docker）
        wget https://github.com/jgm/pandoc/releases/download/3.8.2.1/pandoc-3.8.2.1-1-amd64.deb
        sudo dpkg -i pandoc-3.8.2.1-1-amd64.deb
        pandoc --version  # 验证：应输出 pandoc 3.1.13

    - name: Install Latest Typst (PDF Engine)
      run: |
        # 下载 Typst 0.14.0（你指定的版本，兼容四列表格模板）
        wget https://github.com/typst/typst/releases/download/v0.14.0/typst-x86_64-unknown-linux-musl.tar.xz
        tar -xf typst-x86_64-unknown-linux-musl.tar.xz
        sudo mv typst-x86_64-unknown-linux-musl/typst /usr/local/bin/
        sudo chmod +x /usr/local/bin/typst
        typst --version  # 验证：应输出 typst 0.14.0

    - name: Convert MD to PDF with Pandoc + Typst
      run: |
        # 直接用原生 Pandoc + Typst（无 Docker，路径用绝对路径避免 withBinaryFile 错误）
        pandoc \
          dictionary.md \
          -o output.pdf \
          --pdf-engine=typst \
          --template=template.typ \
          --wrap=preserve \
          --top-level-division=chapter \
          -f markdown+raw_attribute+smart \
          --pdf-engine-opt=--font-path=.
        ls -la output.pdf  # 验证输出：应显示 ~50-100MB PDF 文件

    - name: Upload PDF as Artifact
      uses: actions/upload-artifact@v4
      with:
        name: dictionary-pdf
        path: output.pdf
        retention-days: 30  # 保留 30 天，可下载

    - name: Upload PDF as Release (optional, if on main branch)
      if: github.ref == 'refs/heads/main'
      uses: softprops/action-gh-release@v2
      with:
        files: output.pdf
        tag_name: v1.0-${{ github.run_number }}
        name: Dictionary PDF Build ${{ github.run_number }}
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
name: Build Dictionary PDF

on:
  push:
    branches: [ main ]  # 推送到 main 分支时自动触发
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # 允许手动触发（在 GitHub 仓库的 Actions 标签页点击 Run）

jobs:
  build:
    runs-on: ubuntu-latest  # 用 Ubuntu，内存足

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4  # 拉取你的代码，包括 dictionary.md 和 template.typ

    - name: Install Typst (PDF engine)
      run: |
        # 下载最新 Typst CLI（GitHub Actions 预装 Rust，但我们用预编译二进制）
        wget https://github.com/typst/typst/releases/download/v0.14.0/typst-x86_64-unknown-linux-musl.tar.xz
        tar -xf typst-x86_64-unknown-linux-musl.tar.xz
        sudo mv typst-x86_64-unknown-linux-musl/typst /usr/local/bin/
        typst --version  # 验证安装

    - name: Convert MD to PDF with Pandoc + Typst
      run: |
        # 用 pandoc/core:3.1（已拉取成功），但移除 raw_typst（3.1 不支持）
        # 改用 +raw_attribute（支持内嵌 raw 块，但不指定 typst 类型）
        # 如果你的 MD 无内嵌 Typst，这就够了；否则用 pandoc/core:latest（见备选）
        docker run --rm -v $(pwd):/data pandoc/core:3.1 pandoc \
          /data/dictionary.md \
          -o /data/output.pdf \
          --pdf-engine=typst \
          --template=/data/template.typ \
          --wrap=preserve \
          --top-level-division=chapter \
          -f markdown+raw_attribute+smart \
          --pdf-engine-opt=--font-path=/data
        ls -la output.pdf  # 验证输出文件存在

    - name: Upload PDF as Artifact
      uses: actions/upload-artifact@v4
      with:
        name: dictionary-pdf
        path: output.pdf
        retention-days: 30  # 保留 30 天，可下载

    - name: Upload PDF as Release (optional, if on main branch)
      if: github.ref == 'refs/heads/main'
      uses: softprops/action-gh-release@v2
      with:
        files: output.pdf
        tag_name: v1.0-${{ github.run_number }}  # 每次构建新版本
        name: Dictionary PDF Build ${{ github.run_number }}
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
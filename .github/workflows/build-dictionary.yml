name: Build Dictionary PDF

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4  # 拉取 dictionary.md 和 template.typ

    - name: Install Dependencies
      run: |
        # 更新 apt 并安装 wget、tar 等基本工具（Ubuntu 已预装大部分）
        sudo apt update
        sudo apt install -y wget tar xz-utils  # xz-utils 用于解压 .tar.xz

    - name: Install Latest Pandoc (Direct Download)
      run: |
        # 下载最新稳定版 Pandoc（3.1.13+，支持 Typst 无 Docker）
        wget https://github.com/jgm/pandoc/releases/download/3.8.2.1/pandoc-3.8.2.1-1-amd64.deb
        sudo dpkg -i pandoc-3.8.2.1-1-amd64.deb
        pandoc --version  # 验证：应输出 pandoc 3.1.13

    - name: Install Latest Typst (PDF Engine)
      run: |
        # 下载 Typst 0.14.0（你指定的版本，兼容四列表格模板）
        wget https://github.com/typst/typst/releases/download/v0.14.0/typst-x86_64-unknown-linux-musl.tar.xz
        tar -xf typst-x86_64-unknown-linux-musl.tar.xz
        sudo mv typst-x86_64-unknown-linux-musl/typst /usr/local/bin/
        sudo chmod +x /usr/local/bin/typst
        typst --version  # 验证：应输出 typst 0.14.0

    - name: Convert MD to PDF with Pandoc + Typst
      run: |
        mkdir parts pdfs

        # 统计总行数
        total_lines=$(wc -l < dictionary.md)
        lines_per_part=$(( (total_lines + 9) / 10 ))   # 向上取整

        # 用 csplit 按行数强行切成 10 份（不管内容是什么，都切）
        csplit -z -f parts/part- -n 2 dictionary.md $lines_per_part {9}

        # 如果最后一份是空的就删掉
        [ -f parts/part-10 ] || rm -f parts/part-10 2>/dev/null || true

        # 每份单独用 pandoc + typst 编译（内存峰值 < 1GB）
        for part in parts/part-??; do
          base=$(basename "$part")
          pandoc "$part" -o "pdfs/${base}.pdf" \
            --pdf-engine=typst \
            --template=template.typ \
            --wrap=preserve \
            -f markdown+smart
        done

        # 用 Typst 官方合并工具合并 10 个 PDF（超快超稳）
        cat > merge.typ <<'EOF'
        #import "@preview/pdfpc:0.1.0": merge
        #merge("pdfs/part-*.pdf", "output.pdf")
        EOF
        typst compile merge.typ

    - name: Upload PDF as Artifact
      uses: actions/upload-artifact@v4
      with:
        name: dictionary-pdf
        path: output.pdf
        retention-days: 30  # 保留 30 天，可下载

    - name: Upload PDF as Release (optional, if on main branch)
      if: github.ref == 'refs/heads/main'
      uses: softprops/action-gh-release@v2
      with:
        files: output.pdf
        tag_name: v1.0-${{ github.run_number }}
        name: Dictionary PDF Build ${{ github.run_number }}
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}